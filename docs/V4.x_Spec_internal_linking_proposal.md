# Proposition de Fonctionnalité : Liens Internes (Wikilinks)

@@Prompt
Ce document décrit une approche pour implémenter un système de liens internes dans BlueNotebook, permettant de naviguer facilement entre les notes et à l'intérieur d'une même note.
 

**A Ajouter:**

- Ancres spécifiques pour pouvoir adresser une imahe, un tableau
- Tableau des liens
- Graphe des liens

## 1. Syntaxe Proposée

Pour que ce soit intuitif et puissant, je suggère d'adopter une syntaxe inspirée des standards du domaine, basée sur des doubles crochets `[[...]]`.

*   **Lien vers une autre note (par date) :**
    *   **Syntaxe** : `[[YYYY-MM-DD]]` (ex: `[[2025-10-26]]`)
    *   **Description** : Crée un lien vers la note du 26 octobre 2025. C'est lisible et facile à parser.

*   **Lien vers un titre dans la note actuelle :**
    *   **Syntaxe** : `[[#Titre de la section]]`
    *   **Description** : Crée un lien vers un titre (heading) dans le document courant.

*   **Lien vers un titre dans une autre note :**
    *   **Syntaxe** : `[[YYYY-MM-DD#Titre de la section]]`
    *   **Description** : Combine les deux pour pointer vers une section précise d'une autre note.

*   **Lien avec un texte personnalisé (alias) :**
    *   **Syntaxe** : `[[YYYY-MM-DD|voir la note d'hier]]` ou `[[#Conclusion|voir la conclusion]]`
    *   **Description** : Le texte affiché dans l'aperçu sera "voir la note d'hier", mais le lien pointera vers la cible `YYYY-MM-DD`.

---

## 2. Plan d'Implémentation Technique

Pour mettre en œuvre cette fonctionnalité, nous devons intervenir à trois niveaux : la coloration dans l'éditeur, le rendu dans l'aperçu, et la gestion du clic sur le lien.

### Étape A : Coloration Syntaxique dans l'Éditeur (`editor.py`)

Il faut d'abord que l'éditeur reconnaisse et colore ces nouveaux liens pour un retour visuel immédiat.

1.  **Définir un nouveau format de couleur** : Dans `MarkdownHighlighter`, on ajoute un format pour les wikilinks, par exemple en utilisant la même couleur que les liens existants, mais en italique.

2.  **Ajouter une règle Regex** : Dans la méthode `highlightBlock`, on ajoute une règle pour détecter la syntaxe `[[...]]` et appliquer le format.

    ```python
    # Dans MarkdownHighlighter.highlightBlock()
    wikilink_pattern = r"\[\[([^\]]+)\]\]"
    for match in re.finditer(wikilink_pattern, text):
        self.setFormat(match.start(), match.end() - match.start(), self.wikilink_format)
    ```

### Étape B : Rendu HTML dans l'Aperçu (`preview.py`)

Ensuite, il faut transformer la syntaxe `[[...]]` en un lien HTML cliquable. Pour cela, on crée une extension Markdown personnalisée. Le défi est qu'un clic ne doit pas être un `href` classique, mais doit communiquer avec l'application PyQt. La meilleure solution est d'utiliser un **schéma d'URL personnalisé** (ex: `bluenotebook://...`).

1.  **Créer un `InlineProcessor` personnalisé** :

    ```python
    # Dans preview.py
    class WikiLinkInlineProcessor(InlineProcessor):
        def handleMatch(self, m, data):
            target = m.group(1).strip()
            text = target
            if "|" in target:
                target, text = target.split("|", 1)

            el = ElementTree.Element("a")
            el.set("href", f"bluenotebook://{target}") # URL personnalisée
            el.text = text
            return el, m.start(0), m.end(0)
    ```

2.  **Enregistrer le processeur** : Dans la méthode `setup_markdown` de `MarkdownPreview`, on enregistre cette nouvelle règle.

    ```python
    # Dans MarkdownPreview.setup_markdown()
    self.md.inlinePatterns.register(
        WikiLinkInlineProcessor(r"\[\[([^\]]+)\]\]", self.md), "wikilink", 176
    )
    ```

### Étape C : Intercepter les Clics sur les Liens (`main_window.py`)

C'est l'étape finale. On configure la `QWebEngineView` pour qu'elle nous notifie lorsqu'un utilisateur clique sur un lien. Si le lien utilise notre schéma `bluenotebook://`, on exécute l'action correspondante.

1.  **Connecter le signal `linkClicked`** :

    ```python
    # Dans MainWindow.setup_connections()
    self.preview.web_view.page().linkClicked.connect(self.on_link_clicked)
    ```

2.  **Implémenter le slot `on_link_clicked`** :

    ```python
    # Dans MainWindow
    def on_link_clicked(self, url: QUrl):
        if url.scheme() == "bluenotebook":
            target = url.host() + url.path() # Récupère "YYYY-MM-DD#Titre"
            # ... Logique pour parser la cible ...
            # Si c'est une date, ouvrir le fichier correspondant.
            # Si c'est un header, faire défiler l'éditeur.
        elif url.scheme() in ["http", "https"]:
            # Ouvrir les liens externes dans le navigateur par défaut
            webbrowser.open(url.toString())
    ```

Avec ces trois étapes, BlueNotebook disposera d'un système de liens internes complet et robuste, transformant l'application en un outil encore plus puissant pour organiser les pensées et les connaissances.
