# Guide Complet : Traduction d'Applications PyQt5

## üìã Vue d'ensemble

Ce guide d√©crit la m√©thode compl√®te pour internationaliser une application PyQt5, incluant :
- Traduction des widgets Qt (boutons, labels, fen√™tres)
- Traduction des f-strings avec variables
- Traduction des messages console
- Configuration dynamique de la langue via fichier JSON

---

## üèóÔ∏è Structure du projet

```
MonProjet/
‚îú‚îÄ‚îÄ settings.json              # Configuration de la langue
‚îú‚îÄ‚îÄ mon_app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py               # Script principal
‚îÇ   ‚îî‚îÄ‚îÄ i18n/                 # Dossier des traductions
‚îÇ       ‚îú‚îÄ‚îÄ app_en.ts         # Fichier source anglais
‚îÇ       ‚îú‚îÄ‚îÄ app_en.qm         # Fichier compil√© anglais
‚îÇ       ‚îú‚îÄ‚îÄ app_fr.ts         # Fichier source fran√ßais
‚îÇ       ‚îî‚îÄ‚îÄ app_fr.qm         # Fichier compil√© fran√ßais
```

---

## 1Ô∏è‚É£ Configuration de la langue (settings.json)

```json
{
    "app": {
        "language": "en_US"
    }
}
```

Valeurs possibles : `"en_US"`, `"fr_FR"`, `"es_ES"`, etc.

---

## 2Ô∏è‚É£ Structure du code Python

### A. Imports n√©cessaires

```python
import sys
import os
import json
from PyQt5.QtWidgets import QApplication, QMainWindow, QPushButton, QLabel
from PyQt5.QtCore import QTranslator, QLocale, QLibraryInfo, QCoreApplication
```

### B. Classe SettingsManager (lecture de la langue)

```python
class SettingsManager:
    """Classe pour lire settings.json."""

    @staticmethod
    def tr(text):
        """Traduction dans le contexte de SettingsManager."""
        return QCoreApplication.translate("SettingsManager", text)

    def __init__(self, filename="settings.json", verbose=False):
        script_dir = os.path.dirname(os.path.abspath(__file__))
        self.settings_path = os.path.join(script_dir, filename)
        self.verbose = verbose
        self.settings = self._load()

    def _load(self):
        if os.path.exists(self.settings_path):
            with open(self.settings_path, "r", encoding="utf-8") as f:
                return json.load(f)
        return {}

    def print_status(self):
        """Affiche le statut APR√àS que les traductions soient charg√©es."""
        if self.verbose:
            print(self.tr("üîç Recherche de settings.json : {0}").format(
                self.settings_path
            ))
            if os.path.exists(self.settings_path):
                print(self.tr("‚úÖ Fichier settings.json trouv√© : {0}").format(
                    self.settings_path
                ))
                print(self.tr("üìÑ Contenu settings.json : {0}").format(
                    self.settings
                ))

    def get(self, key, default=None):
        """R√©cup√®re une cl√© imbriqu√©e comme 'app.language'."""
        try:
            keys = key.split(".")
            value = self.settings
            for k in keys:
                value = value[k]
            return value
        except (KeyError, TypeError):
            return default
```

### C. Classe pour traductions console (hors widgets)

```python
class MainContext:
    """Classe pour traduire les messages console de main()."""
    
    @staticmethod
    def tr(text):
        """Traduction dans le contexte 'MainContext'."""
        return QCoreApplication.translate("MainContext", text)
```

### D. Widgets Qt (fen√™tres, boutons, labels)

```python
class MyWindow(QMainWindow):
    """Fen√™tre principale."""

    def __init__(self):
        super().__init__()
        
        # ‚úÖ CORRECT : Utiliser self.tr() pour les textes statiques
        self.setWindowTitle(self.tr("Titre de la fen√™tre"))
        
        # ‚úÖ CORRECT : f-strings avec .format() APR√àS self.tr()
        index = 2
        total = 10
        self.button = QPushButton(
            self.tr("Fichier {0} sur {1}").format(index, total)
        )
        
        # ‚úÖ CORRECT : Label avec texte traduisible
        self.label = QLabel(
            self.tr("Cliquez sur le bouton pour ouvrir un fichier.")
        )
```

**‚ùå ERREURS √Ä √âVITER :**
```python
# ‚ùå MAUVAIS : f-string avant self.tr()
self.button = QPushButton(self.tr(f"Fichier {index} sur {total}"))

# ‚ùå MAUVAIS : self.tr() sans format()
nombre = "2"
self.button = QPushButton(f"Ouvrir {nombre}")  # Non traduisible !
```

### E. Fonction main() - Ordre CRITIQUE

```python
def main():
    # 1Ô∏è‚É£ Charger settings SILENCIEUSEMENT (avant QApplication)
    settings = SettingsManager(verbose=False)
    lang = settings.get("app.language", "fr_FR")
    
    # 2Ô∏è‚É£ Forcer la variable d'environnement
    os.environ["LANG"] = f"{lang}.UTF-8"
    
    # 3Ô∏è‚É£ Cr√©er QApplication
    app = QApplication(sys.argv)
    
    # 4Ô∏è‚É£ Charger traductions Qt standard (boutons Open/Cancel)
    locale = QLocale(lang)
    qt_translator = QTranslator()
    qt_translation_path = QLibraryInfo.location(QLibraryInfo.TranslationsPath)
    qt_translator.load(locale, "qtbase", "_", qt_translation_path)
    app.installTranslator(qt_translator)
    
    # 5Ô∏è‚É£ Charger VOS traductions (app_en.qm, app_fr.qm)
    app_translator = QTranslator()
    script_dir = os.path.dirname(__file__)
    i18n_path = os.path.join(script_dir, "i18n")
    lang_code = lang.split("_")[0]  # en_US -> en
    qm_file = f"app_{lang_code}.qm"
    qm_path = os.path.join(i18n_path, qm_file)
    
    if app_translator.load(qm_path):
        app.installTranslator(app_translator)
    
    # 6Ô∏è‚É£ MAINTENANT afficher les messages traduits
    tr = MainContext.tr
    settings.print_status()
    print(tr("üåê Langue configur√©e : {0}").format(lang))
    print(tr("‚úÖ Traductions charg√©es : {0}").format(qm_path))
    
    # 7Ô∏è‚É£ Lancer l'interface
    window = MyWindow()
    window.show()
    sys.exit(app.exec_())
```

**üî¥ ORDRE CRITIQUE :**
1. Charger settings **AVANT** `QApplication`
2. Cr√©er `QApplication`
3. Installer les traducteurs
4. **SEULEMENT APR√àS** : afficher les messages console traduits

---

## 3Ô∏è‚É£ Extraction et compilation des traductions

### A. Extraire les textes traduisibles (g√©n√©rer .ts)

```bash
# Cr√©er/mettre √† jour les fichiers .ts
pylupdate5 main.py -ts i18n/app_en.ts
pylupdate5 main.py -ts i18n/app_fr.ts
```

**R√©sultat :** Fichiers `.ts` XML avec tous les textes `self.tr()` et `MainContext.tr()`

### B. Correction manuelle du fichier .ts (si n√©cessaire)

Si `pylupdate5` g√©n√®re un contexte `@default` au lieu de `MainContext`, √©ditez le fichier `.ts` :

**AVANT :**
```xml
<context>
    <name>@default</name>
    <message>
        <source>üåê Langue configur√©e : {0}</source>
        <translation type="unfinished"></translation>
    </message>
</context>
```

**APR√àS :**
```xml
<context>
    <name>MainContext</name>
    <message>
        <source>üåê Langue configur√©e : {0}</source>
        <translation type="unfinished"></translation>
    </message>
</context>
```

### C. Traduire avec Qt Linguist

1. Ouvrir Qt Linguist
2. Charger `i18n/app_en.ts`
3. Traduire tous les messages
4. Sauvegarder

**Exemple de traduction :**
```
Source (fran√ßais) : "Fichier {0} sur {1}"
Translation (anglais) : "File {0} of {1}"
```

**‚ö†Ô∏è IMPORTANT :** Les placeholders `{0}`, `{1}` doivent rester identiques !

### D. Compiler les traductions (g√©n√©rer .qm)

```bash
lrelease i18n/app_en.ts -qm i18n/app_en.qm
lrelease i18n/app_fr.ts -qm i18n/app_fr.qm
```

**R√©sultat :** Fichiers `.qm` binaires utilis√©s par Qt

---

## 4Ô∏è‚É£ R√®gles essentielles

### ‚úÖ Bonnes pratiques

1. **Widgets Qt** : Toujours utiliser `self.tr("texte")`
2. **Variables dynamiques** : Utiliser `.format()` APR√àS `self.tr()`
   ```python
   self.tr("Message {0}").format(variable)
   ```
3. **Messages console** : Cr√©er une classe avec m√©thode `tr()` statique
4. **Placeholders** : Utiliser `{0}`, `{1}`, `{2}` (jamais de f-strings avant `tr()`)
5. **Contextes** : Un contexte = une classe (SettingsManager, MainContext, MyWindow)
6. **Ordre** : Charger traductions AVANT d'afficher messages

### ‚ùå Erreurs courantes

1. **F-string avant tr()** :
   ```python
   # ‚ùå MAUVAIS
   self.label = QLabel(self.tr(f"Fichier {index}"))
   
   # ‚úÖ BON
   self.label = QLabel(self.tr("Fichier {0}").format(index))
   ```

2. **Messages console avant QApplication** :
   ```python
   # ‚ùå MAUVAIS
   settings = SettingsManager(verbose=True)  # Print avant QApp !
   app = QApplication(sys.argv)
   
   # ‚úÖ BON
   settings = SettingsManager(verbose=False)
   app = QApplication(sys.argv)
   app.installTranslator(...)
   settings.print_status()  # Print APR√àS traducteur
   ```

3. **Oublier QCoreApplication.translate()** :
   ```python
   # ‚ùå MAUVAIS
   def ma_fonction():
       print("Message non traduisible")
   
   # ‚úÖ BON
   class MonContexte:
       @staticmethod
       def tr(text):
           return QCoreApplication.translate("MonContexte", text)
   
   def ma_fonction():
       print(MonContexte.tr("Message traduisible"))
   ```

---

## 5Ô∏è‚É£ Flux de travail complet

```
1. √âcrire le code avec self.tr() et MainContext.tr()
   ‚Üì
2. pylupdate5 main.py -ts i18n/app_en.ts
   ‚Üì
3. Corriger @default ‚Üí MainContext dans .ts (si n√©cessaire)
   ‚Üì
4. Traduire avec Qt Linguist
   ‚Üì
5. lrelease i18n/app_en.ts -qm i18n/app_en.qm
   ‚Üì
6. Modifier settings.json ‚Üí "language": "en_US"
   ‚Üì
7. Lancer l'application ‚Üí Tout est en anglais !
```

---

## 6Ô∏è‚É£ Exemple complet minimal

```python
import sys
import os
import json
from PyQt5.QtWidgets import QApplication, QMainWindow, QPushButton
from PyQt5.QtCore import QTranslator, QLocale, QLibraryInfo, QCoreApplication

class MainContext:
    @staticmethod
    def tr(text):
        return QCoreApplication.translate("MainContext", text)

class MyWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle(self.tr("Ma fen√™tre"))
        self.button = QPushButton(self.tr("Cliquer ici"))

def main():
    # Charger langue
    with open("settings.json", "r") as f:
        lang = json.load(f)["app"]["language"]
    
    os.environ["LANG"] = f"{lang}.UTF-8"
    app = QApplication(sys.argv)
    
    # Charger traductions
    locale = QLocale(lang)
    qt_translator = QTranslator()
    qt_translator.load(locale, "qtbase", "_", 
                       QLibraryInfo.location(QLibraryInfo.TranslationsPath))
    app.installTranslator(qt_translator)
    
    app_translator = QTranslator()
    app_translator.load(f"i18n/app_{lang.split('_')[0]}.qm")
    app.installTranslator(app_translator)
    
    # Messages console (APR√àS traducteurs)
    print(MainContext.tr("Application d√©marr√©e"))
    
    window = MyWindow()
    window.show()
    sys.exit(app.exec_())

if __name__ == "__main__":
    main()
```

---

## 7Ô∏è‚É£ Checklist finale

- [ ] `settings.json` avec cl√© `app.language`
- [ ] Dossier `i18n/` cr√©√©
- [ ] Imports : `QCoreApplication` ajout√©
- [ ] Classe `MainContext` avec m√©thode `tr()` statique
- [ ] `SettingsManager` avec `verbose=False` et `print_status()`
- [ ] Tous les textes utilisent `self.tr()` ou `MainContext.tr()`
- [ ] Variables avec `.format()` APR√àS `tr()`
- [ ] `pylupdate5` ex√©cut√©
- [ ] Contexte `@default` corrig√© en `MainContext` dans `.ts`
- [ ] Traductions faites dans Qt Linguist
- [ ] `lrelease` ex√©cut√©
- [ ] Messages console affich√©s APR√àS `app.installTranslator()`

---

## üéØ R√©sum√© en 3 points

1. **Structure** : Classe avec `@staticmethod tr()` pour chaque contexte de traduction
2. **Ordre** : QApplication ‚Üí installTranslator ‚Üí messages console
3. **Format** : `self.tr("Texte {0}").format(variable)` jamais `self.tr(f"Texte {variable}")`

---

**Ce guide est applicable √† tous vos projets PyQt5 futurs ! üöÄ**